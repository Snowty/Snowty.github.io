---
layout: post
title: 安全岗面试相关问题--web常见漏洞原理与防御
date: 2018-03-06
tags: Sec 
---

### 怎么又要开始准备面试了
下面总结的内容都比较简略，可能是摘抄了《白帽子》，可能是网上搜集的资料，或者直接给出了别人总结的很好的文章供以后查看，因为每个点展开来将都可以写好几篇文章（嗯，为自己偷懒找借口

### XSS

+ 常见类型：

    + 反射型XSS：把用户输入的数据“反射”给浏览器，即需要用户点击某链接
    + 存储型XSS：把用户输入的数据存储在服务器
    + DOM Based XSS：也属于反射型XSS，修改页面的DOM节点形成XSS

+ 其他类型的XSS：[跨站的艺术-XSS入门与介绍](http://www.fooying.com/the-art-of-xss-1-introduction/)

    + mXSS:突变型XSS，原本无害，而由于一些特殊原因，如反编码等，导致Payload发生变异，导致的XSS。如：旧版QQ客户端中的链接预览。
    + UXSS:利用浏览器或者浏览器扩展漏洞来制造产生XSS的条件并执行代码的一种攻击类型,可以理解为Bypass同源策略。[通用跨站脚本攻击(UXSS)](http://www.fooying.com/uxss/)
    + Flash XSS:来源于 getURL/navigateToURL（访问跳转）、ExternalInterface.call（调用js函数）
    + UTF-7 XSS:低版本IE中未指定meta编码或指定编码为UTF-7
    + MHTML XSS:低版本IE中
    + CSS XSS:`body {width:expression(alert(1));: red;}`
    + VBScript XSS:`<input type ="button" onClick="VBScript:Document.Write 'hello mr. Fooying' MsgBox 'xss'">`

+ 注入点：
    GET参数、POST参数、UA、Referer...一切可以提交的输入点

+ 危害：[浅谈跨站脚本攻击与防御](https://thief.one/2017/05/31/1/)
    
    + cookie劫持
    + 后台增删改文章
    + 钓鱼，利用xss构造出一个登录框，骗取用户账户密码。
    + xss蠕虫（利用xss漏洞进行传播）
    + 修改网页代码:必须存在存储型xss漏洞，并且将结果返回到页面上
    （javascript加载外部的代码文件可以是任意扩展名（无扩展名也可以））
    + 利用网站重定向
    + 获取用户信息（如浏览器信息，IP地址等）:调用java Applet的接口获取客户端本地IP

+ 防御：

    + 在Cookie中设置`HttpOnly`标识,禁止页面的js访问带有httponly属性的cookie
    + XSS Filter：过滤用户输入的危险字符，设置黑白名单
    + 输出检查：编码和转义，常用编码：html编码、url编码、js编码、16进制、base64等，使得浏览器无法解析执行js代码
    + 针对不同位置的输出，使用不同的处理方式
    + 处理富文本:限制用户能使用的标签，限制为只能使用a、div等安全的标签
    + header中使用content-Sencurity-Policy字段，规定请求js的域名白名单（CSP策略）

+ 绕过：
    + 转换大小写
    + 大小写混写
    + 双引号改单引号
    + 引号改为/
    + 用全角字符
    + 使用javascript伪协议
    + 使用回车、空格等特殊字符
    + 在css的style中使用/**/注释符
    + 使用字符编码
    + 利用事件触发xss

    [浅谈XSS—字符编码和浏览器解析原理](https://security.yirendai.com/news/share/26)    

+ 常用payload：[t00ls](https://www.t00ls.net/thread-42640-1-1.html)
        
### SQL Injection:

+ 原理：通过把sql命令插入到web表单提交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行的sql命令的目的

+ 常规做法：
    + 找出查询语句的方法是在后面加`’` 、 `“` 、 `‘)`  、 `“)`,看是否报错，然后用`and 1=1`和`and 1=2`判断是否存在注入点，然后根据情况用不同的方法注入
    + [SQLi备忘录](http://pentestmonkey.net/category/cheat-sheet/sql-injection)
    + 确定显示位，可以先尝试用`select 1,2,3,4,5……,n#`来检测，之后的查询最好用`select @,@,@#`、`select NULL,NULL,NULL#`，可以保证不会因为数据类型不匹配而测试失败
    + 查询数据库名，`SELECT group_concat(schema_name) FROM information_schema.schemata`
    + 查询表名，`select group_concat(table_name) from information_schema.tables where table_schema=’xxxxx’`
    + 查询列名，`Select groupc_concat(column_name) from information_schema.columns where table_name=’xxxxx’`
    + 爆数据，`Select group_concat(column_name) from table_name`   

+ [分类](http://blog.51cto.com/wt7315/1828167)：
    + 基于联合查询
        + UNION:合并两个或多个SELECT语句的结果集，并消去表中重复的行。UNION 内部的 SELECT 语句必须拥有相同数量的列，列也必须拥有相似的数据类型。
        + `and 1=2 union select 1,version(),database()`可以爆出当前使用的版本和数据库名
    + [基于错误回显](http://blog.51cto.com/wt7315/1891458)
        + 通过sql语句的矛盾性来使数据被回显到页面上
        <img src = "/images/posts/2018/03/web//报错.png" height="400" width="800">

    + 基于盲注
        + 时间盲注: `and if(ascii(substr((select schema_name from information_schema.schemata limit 1,1),1,1))>100,1,sleep(3))%23` 
        + 布尔型的盲注: 爆数据库的路径`and ascii(substr(@@datadir,1,1)）>69 %23`然后使用二分法一步一步确定
    + 基于user-agent
    + 基于feferer
    + 基于cookie
    + 二次注入:分为语句插入和语句执行
    + [宽字节注入](http://www.91ri.org/8611.html):  （字符集好方啊，我得专门总结一篇啊😂
        + mysql的转义函数：`addslashes`，`mysql_real_escape_string`，`mysql_escape_string`
        + `\`的ascii码为`0x5c`,会结合成新的字符
    + [其他](https://www.anquanke.com/post/id/85936)：
        + 读文件：SELECT LOAD_FILE('/etc/passwd');
        + 写文件：SELECT '<? system($_GET['c']); ?>' INTO OUTFILE '/var/www/shell.php';
        + 带外通道：利用其他协议或者渠道从服务器提取数据. 它可能是HTTP（S）请求，DNS解析服务，SMB服务，Mail服务等.

+ [sqlmap的使用](http://www.zerokeeper.com/web-security/sqlmap-usage-summary.html)，最基础的使用方法如下：
    + sqlmap -u "xxx"
    + sqlmap -u "xxx" --current-db
    + sqlmap -u "xxx" -D DB名 --tables
    + sqlmap -u "xxx" -D DB名 -T 表名 --columns
    + sqlmap -u "xxx" -D DB名 -T 表名 -C 字段名 --dump
    + [tamper绕WAF](http://www.lengbaikai.net/?p=110)

+ 其他注入：
    + XML注入
    + 代码注入
    + CRLF注入：\r\n,0x0d,0x0a


+ 防御：
    + waf
    + 使用预编译语句，绑定变量
    + 检查数据类型，例如限制输入数据只能为int
    + 使用安全函数,encodeForSQL()
    + 最小权限原则，避免直接使用root

### CSRF:

+ 原理：通过伪装来自受信任用户的请求来利用受信任的网站,例如：用户登录某账户，浏览器获得cookie；攻击者诱使用户访问某构造好的恶意CSRF页面。

+ 防御：
    + 验证码
    + Referer Check（HTTPS跳转到HTTP不会发送Referer）
    + Anti CSRF Token

### SSRF（Server-Side Request Forgery）
    
[浅谈SSRF漏洞](https://www.cnblogs.com/s0ky1xd/p/5859049.html)
[SSRF漏洞分析与利用](http://www.91ri.org/17111.html)
[SSRF in PHP](https://joychou.org/web/phpssrf.html)

+ 原理：利用漏洞伪造服务器端发起请求，从而突破客户端获取不到数据限制，一般用来在外网探测或攻击内网服务

+ 可利用的伪协议：`dict file ftp ftps gopher http https imap imaps pop3 pop3s rtsp smb smbs smtp smtps telnet tftp `

 <img src = "/images/posts/2018/03/web//ssrf.png" height="400" width="800">

+ 防御：
    + 过滤返回信息
    + 限制请求端口为http常用的端口
    + 内网IP黑名单
    + 禁用不需要的协议
    
### XXE
[浅谈XXE漏洞攻击与防御](https://thief.one/2017/06/20/1/)

+ 原理：应用程序解析XML输入时，没有禁止外部实体的加载，导致可加载恶意外部文件，造成文件读取、命令执行、内网端口扫描、攻击内网网站、发起dos攻击等危害。
    + `<!ENTITY 实体名称 SYSTEM "URI">`,支持file、http、https、ftp等
    + 触发的点往往是可以上传xml文件的位置，没有对上传的xml文件进行过滤，导致可上传恶意xml文件

+ 防御：
    + 使用开发语言提供的禁用外部实体的方法
    + 过滤用户提交的XML数据，过滤关键词：<!DOCTYPE和<!ENTITY，或者SYSTEM和PUBLIC。



